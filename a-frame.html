<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaction avec Objets A-Frame</title>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-animation-component@3.2.1/dist/aframe-animation-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/super-hands@^3.0.3/dist/super-hands.min.js"></script>
    <script src="https://cdn.rawgit.com/ephwan/cannon-es/master/cannon-es.min.js"></script> <!-- Ajout de la bibliothèque Cannon.js -->
    
    <script>
        // Assurez-vous que la bibliothèque Cannon est chargée avant d'utiliser ses fonctionnalités.
        AFRAME.registerComponent('grab-handler', {
            schema: {
                isGrabbed: {type: 'boolean', default: false},
                hand: {type: 'selector'}
            },

            init: function () {
                this.el.addEventListener('grab-start', (evt) => {
                    this.data.isGrabbed = true;
                    this.data.hand = evt.detail.hand;
                });

                this.el.addEventListener('grab-end', () => {
                    this.data.isGrabbed = false;
                });
            },

            tick: function () {
                if (this.data.isGrabbed) {
                    const handRotation = this.data.hand.object3D.rotation;
                    this.el.object3D.rotation.set(handRotation.x, handRotation.y + Math.PI, -handRotation.z);
                }
            }
        });

        AFRAME.registerComponent('shoot', {
            schema: {
                bulletSpeed: {type: 'number', default: 10}
            },

            init: function () {
                this.el.addEventListener('triggerdown', () => {
                    this.shootBullet();
                });
            },

            shootBullet: function () {
                const bullet = document.createElement('a-sphere');
                bullet.setAttribute('radius', 0.1);
                bullet.setAttribute('color', '#FFC65D');

                // Obtenir la position de l'embout du pistolet
                const gunPosition = this.el.getAttribute('position');
                const direction = new THREE.Vector3();
                this.el.object3D.getWorldDirection(direction);

                // Placer la balle à l'embout du pistolet
                bullet.setAttribute('position', 
                    ${gunPosition.x + direction.x * 0.5} ${gunPosition.y + direction.y * 0.5} ${gunPosition.z + direction.z * 0.5}
                );
                bullet.setAttribute('dynamic-body', ''); // Assure que la sphère soit dynamique pour la physique

                // Ajouter la sphère à la scène
                this.el.sceneEl.appendChild(bullet);

                // Appliquer une force pour simuler le tir
                bullet.body = new CANNON.Body({
                    mass: 1,
                    position: new CANNON.Vec3(
                        gunPosition.x + direction.x * 0.5,
                        gunPosition.y + direction.y * 0.5,
                        gunPosition.z + direction.z * 0.5
                    )
                });
                bullet.body.addShape(new CANNON.Sphere(0.1));
                bullet.body.applyImpulse(new CANNON.Vec3(direction.x, direction.y, direction.z).scale(this.data.bulletSpeed), bullet.body.position);
            }
        });
    </script>
</head>
<body>
    <a-scene physics>
        <a-light type="ambient" color="#fff" intensity="0.5"></a-light>
        <a-light type="directional" color="#fff" intensity="1" position="-1 1 1" castshadow></a-light>

        <a-box position="-1 0.5 -3" rotation="0 45 0" color="#4CC3D9" shadow grabbable></a-box>
        <a-sphere position="1 1 -3" radius="0.5" color="#EF2D5E" shadow grabbable></a-sphere>
        <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4" shadow></a-plane>

        <a-entity id="rig" movement-controls>
            <a-camera position="0 1.6 0" look-controls></a-camera>
            <a-entity sphere-collider="objects: a-box, a-sphere, [id = gun];" super-hands id="rightHand" hand-controls="hand: right; handModelStyle: lowPoly; color: #ffcccc"></a-entity>
            <a-entity sphere-collider="objects: a-box, a-sphere, [id = gun];" super-hands id="leftHand" hand-controls="hand: left; handModelStyle: lowPoly; color: #ffcccc"></a-entity>
        </a-entity>

        <a-entity 
            id="gun"
            gltf-model="https://cdn.glitch.global/cc760f87-4732-4c60-b802-97b8d8bdf11c/1911.glb?v=1728640604199" 
            position="0 1 -5" 
            scale="0.07 0.07 0.07"
            grabbable
            grab-handler
            shoot>
        </a-entity>
        
        <a-box grabbable position="-1.5 1.5 -3" color="yellow"></a-box>
    </a-scene>
</body>
</html>